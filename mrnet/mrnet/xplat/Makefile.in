#/****************************************************************************
# * Copyright © 2003-2005 Dorian C. Arnold, Philip C. Roth, Barton P. Miller *
# *                  Detailed MRNet usage rights in "LICENSE" file.          *
# ****************************************************************************/
# $Id: Makefile.in,v 1.14 2008/10/09 19:50:12 mjbrim Exp $
@SET_MAKE@

AR      = @AR@
ARFLAGS = @ARFLAGS@
RANLIB  = @RANLIB@

prefix  = @prefix@
exec_prefix=@exec_prefix@
srcdir  = @abs_srcdir@
libdir  = @libdir@
includedir  = @includedir@

VPATH   = @abs_srcdir@/src

CXX = @CXX@
INSTALL = @INSTALL@

MAKEDEPENDS = $(srcdir)/../conf/makedepends.sh

BUILD_SHARED_LIBS = @BUILDSHARED@

TARGET = libxplat.a
TARGET_SO = libxplat.so

INCFLAGS = -I$(srcdir)/include -I$(srcdir)/src -I. -I$(srcdir)/.. -I$(srcdir)/../src -I$(srcdir)/../include
CXXFLAGS = @CXXFLAGS@ $(INCFLAGS) $(WARNFLAGS)
SOFLAGS = @SOFLAGS@
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@

TARGETS = $(TARGET)
ifeq ($(BUILD_SHARED_LIBS), yes)
    TARGETS += $(TARGET_SO)
endif 

SRCS    = Monitor-pthread.C \
          Mutex-pthread.C \
          TLSKey-pthread.C \
          Once-pthread.C \
          SharedObject-unix.C \
          NCIO-unix.C \
          Process.C \
          Process-unix.C \
          Thread-pthread.C \
          Tokenizer.C \
          NetUtils.C \
          NetUtils-unix.C \
          PathUtils-unix.C \
          SocketUtils-unix.C \
          Error-unix.C

OBJS    = $(SRCS:.C=.o)
DEPS    = $(SRCS:.C=.d)

all: $(TARGETS)

sharedobj: $(TARGET_SO)

$(TARGET): $(OBJS)
	@echo Archiving `basename $@` ...
	$(AR) $(ARFLAGS) $@ $?
	$(RANLIB) $@

$(TARGET_SO): $(OBJS)
	@echo Building `basename $@` ...
	$(CXX) $(SOFLAGS) -o $@ $(OBJS)

install: $(TARGETS)
	for dir in $(libdir) $(includedir) $(includedir)/xplat ; do \
	    if [ ! -d $$dir ] ; then \
	        mkdir -p $$dir ; \
	        chmod 755 $$dir ; \
	    fi \
	done
	if [ ! -x `echo $(INSTALL) | sed 's/ .*$$//'` ] ; then \
	    chmod +x `echo $(INSTALL) | sed 's/ .*$$//'` ; \
	fi
	$(INSTALL) -p -m 555 $(TARGET) $(libdir)/
	if [ "$(BUILD_SHARED_LIBS)" == "yes" ] ; then \
            $(INSTALL) -p -m 555 $(TARGET_SO) $(libdir)/ \
        fi
	for hdr in @srcdir@/include/xplat/*.h ; do \
	    $(INSTALL) -p -m 444 $$hdr $(includedir)/xplat/ ; \
	done

clean:
	$(RM) $(OBJS)

distclean: clean
	$(RM) $(TARGETS) $(DEPS) config.status config.log config.h Makefile

# pattern rules
@VERBOSEMAKE@
.SUFFIXES:
.SUFFIXES: .c .C .o .d

# add phony target to force serial build of xplat.
# this would not be needed if archive was built differently
# -- and then we could build in parallel
.NOTPARALLEL:

# TODO this must change - copied from gnu make info files
#%.d:    %.C
#set -e; $(CXX) -MM $(CXXFLAGS) $< | \
#sed 's/\($*\)\.o[ :]*/\1.o $@ : /g' > $@; \
#[ -s $@ ] || rm -f $@

%.d: %.C
	@echo Building depends file `basename $@` ...
	$(MAKEDEPENDS)  $< $*.o $@ $(INCFLAGS)

%.o: %.c
	@echo Compiling `basename $@` ...
	$(CXX) $(CXXFLAGS) $(C_AS_CPLUSPLUS) -o $@ -c $<

%.o: %.C
	@echo Compiling `basename $@` ...
	$(CXX) $(CXXFLAGS) -o $@ -c $<

# make sure file dependencies are determiend and used
-include $(DEPS)
