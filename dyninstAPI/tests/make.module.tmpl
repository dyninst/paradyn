# 
# Common makefile template for dyninst Tests.  This file is not intended to
# be a useful Makefile in isolation; instead, it should be included
# from within an architecture-specific Makefile.
#
# $Id: make.module.tmpl,v 1.20 2000/03/13 16:23:57 paradyn Exp $
#

SUITE_NAME	= Dyninst
RELEASE_NUM	= 2.0beta
#BUILD_MARK should be (re-)defined in core/make.config.local rather than here!

DEST		= $(TO_CORE)/$(PROGRAM_DEST)/testprogs

ifdef TARGET
SRCS	     += ../src/$(TARGET).C ../src/test_util.C
else
TARGETS        = test1 test2 test3 test4 \
		 test1.mutatee_gcc \
		 test2.mutatee_gcc \
		 test3.mutatee_gcc \
		 test4a.mutatee_gcc \
		 test4b.mutatee_gcc

ifdef NATIVE_CC
TARGETS      +=  test1.mutatee_$(NATIVE_CC) \
		 test2.mutatee_$(NATIVE_CC) \
		 test3.mutatee_$(NATIVE_CC) \
		 test4a.mutatee_$(NATIVE_CC) \
		 test4b.mutatee_$(NATIVE_CC)
endif

ifdef USES_LIBDYNINSTRT_SO
TARGETS      += libtestA.so libtestB.so
endif
SRCS	     += ../src/test1.C ../src/test1.mutatee.c ../src/test_util.C \
		../src/test2.C ../src/test2.mutatee.c \
		../src/test3.C ../src/test3.mutatee.c \
		../src/test4.C ../src/test4a.mutatee.c ../src/test4b.mutatee.c \
                ../src/libtestA.c ../src/libtestB.c

endif

VPATH	     +=

CXXFLAGS     += -I../../h $(BASICWARNINGS)
CFLAGS       += -I../../h $(BASICWARNINGS)

#LIBS         += -static -ldyninstAPI -lpdutil
LIBS         += -ldyninstAPI -lpdutil
ifndef USES_LIBDYNINST_SO
LIBS         += -lpdutil
endif
SYSLIBS      += -liberty

all:
	$(MAKE) aTest MUTATEE_CC=gcc TARGET=test1 TARGET2=test1.mutatee_gcc
	$(MAKE) aTest MUTATEE_CC=gcc TARGET=test2 TARGET2=test2.mutatee_gcc
	$(MAKE) aTest MUTATEE_CC=gcc TARGET=test3 TARGET2=test3.mutatee_gcc
	$(MAKE) aTest MUTATEE_CC=gcc TARGET=test4 TARGET2=test4a.mutatee_gcc
	$(MAKE) aTest MUTATEE_CC=gcc TARGET2=test4b.mutatee_gcc
	$(MAKE) testlibs
ifdef NATIVE_CC
	$(MAKE) aTest MUTATEE_CC=$(NATIVE_CC) TARGET2=test1.mutatee_$(NATIVE_CC)
	$(MAKE) aTest MUTATEE_CC=$(NATIVE_CC) TARGET2=test2.mutatee_$(NATIVE_CC)
	$(MAKE) aTest MUTATEE_CC=$(NATIVE_CC) TARGET2=test3.mutatee_$(NATIVE_CC)
	$(MAKE) aTest MUTATEE_CC=$(NATIVE_CC) TARGET2=test4a.mutatee_$(NATIVE_CC)
	$(MAKE) aTest MUTATEE_CC=$(NATIVE_CC) TARGET2=test4b.mutatee_$(NATIVE_CC)
endif

pc:
	$(MAKE) purecov TARGET=test1 TARGET2=test1.mutatee
	$(MAKE) purecov TARGET=test2 TARGET2=test2.mutatee

aTest:	$(TARGET) $(TARGET2)

ifdef USES_LIBDYNINSTRT_SO
testlibs: libtestA.so libtestB.so
else
testlibs:
endif

UNCOMMON_INSTALL=true

install: all
	-@$(MKDIR) $(DEST)
	-$(CP) $(TARGETS) $(DEST)

