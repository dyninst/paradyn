#
# Common makefile template for rtinst library.  This file is not
# intended to be a useful Makefile in isolation; instead, it should be
# included from within an architecture-specific Makefile.
#
# $Id: make.module.tmpl,v 1.14 1997/11/28 21:17:38 wylie Exp $
#

ifndef TARGET
TARGET	      = libdyninstRT.o
ALT_TARGET    = DYNINSTstartCode.o DYNINSTendCode.o RTpvmPiggy.o RTcriticalPath.o
endif

MODCC         = $(CC)
MODCFLAGS     = $(CFLAGS)

SRCS	     += ../src/RTinst.c ../src/RTend.c
SRCS2	     += ../src/RTend.c

DYNSRCS	      = ../src/DYNINSTstartCode.c \
		../src/DYNINSTendCode.c

ifdef USES_SHM_SAMPLING
CFLAGS	+= -DSHM_SAMPLING
endif

ifdef USES_LIBDYNINSTRT_SO
all: $(TARGET3)
else
all: $(TARGET) $(TARGET2) $(ALT_TARGET)
endif

#
# override standard link rule; libdyninst is not really a library or a program.
#
UNCOMMON_LINK= true

OBJS =		$(patsubst %.C, %.o, $(filter %.C,$(notdir $(SRCS)))) \
		$(patsubst %.c, %.o, $(filter %.c,$(notdir $(SRCS)))) \
		$(patsubst %.s, %.o, $(filter %.s,$(notdir $(SRCS)))) \
		$(patsubst %.S, %.o, $(filter %.S,$(notdir $(SRCS)))) \
		$(IGEN_GEN_SRCS:%.C=%.o)

ifndef USES_LIBDYNINSTRT_SO
$(TARGET): $(OBJS) $(LIBS)
	$(LD) $(LDFLAGS) -o $(TARGET) $(OBJS) $(LIBS) -lgcc
endif

#
# override standard install rule; provide a default DEST if not already set
#
ifndef DEST
DEST		= $(TO_CORE)/../lib/$(PLATFORM)
endif

UNCOMMON_INSTALL= true
ifdef USES_LIBDYNINSTRT_SO
install: $(DEST)/$(TARGET3) \
	 $(DEST)/DYNINSTstartCode.o \
	 $(DEST)/DYNINSTendCode.o \
	 $(DEST)/RTpvmPiggy.o
else
install: $(DEST)/$(TARGET) \
	 $(DEST)/DYNINSTstartCode.o \
	 $(DEST)/DYNINSTendCode.o \
	 $(DEST)/RTpvmPiggy.o
endif
$(DEST)/libdyninstRT.o:       libdyninstRT.o
	-cp libdyninstRT.o ../../../lib/$(PLATFORM)

$(DEST)/libdyninstRT.so.1:       libdyninstRT.so.1
	-cp libdyninstRT.so.1 ../../../lib/$(PLATFORM)

$(DEST)/RTpvmPiggy.o: RTpvmPiggy.o
	-cp RTpvmPiggy.o ../../../lib/$(PLATFORM)

$(DEST)/DYNINSTstartCode.o: DYNINSTstartCode.o
	-cp DYNINSTstartCode.o ../../../lib/$(PLATFORM)

$(DEST)/DYNINSTendCode.o: DYNINSTendCode.o
	-cp DYNINSTendCode.o ../../../lib/$(PLATFORM)
