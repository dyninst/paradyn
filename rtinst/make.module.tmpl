#
# Common makefile template for rtinst library.  This file is not
# intended to be a useful Makefile in isolation; instead, it should be
# included from within an architecture-specific Makefile.
#
# $Id: make.module.tmpl,v 1.18 2000/03/31 22:07:18 wylie Exp $
#

ifndef TARGET
TARGET		= libdyninstRT.o
endif

ifdef USES_LIBDYNINSTRT_SO
TARGET3_SO	= libdyninstRT.so.1
endif

ifdef INCLUDE_CP_PROFILING
TARGET2		= libdyninstCP.o
CP_OBJS		= RTpvmPiggy.o RTcriticalPath.o
endif

ifdef BUILD_CODE_BLOCKS        
ALT_TARGET	= DYNINSTstartCode.o DYNINSTendCode.o 
endif

MODCC         = $(CC)
MODCFLAGS     = $(CFLAGS)

SRCS	     += ../src/RTinst.c ../src/RTend.c

ifdef USES_SHM_SAMPLING
CFLAGS	+= -DSHM_SAMPLING
endif

ifdef USES_LIBDYNINSTRT_SO
#all: $(TARGET) $(TARGET2) 
all: $(TARGET3_SO) $(TARGET2) 
else
all: $(TARGET) $(TARGET2) $(ALT_TARGET)
endif

OBJS =		$(patsubst %.C, %.o, $(filter %.C,$(notdir $(SRCS)))) \
		$(patsubst %.c, %.o, $(filter %.c,$(notdir $(SRCS)))) \
		$(patsubst %.s, %.o, $(filter %.s,$(notdir $(SRCS)))) \
		$(patsubst %.S, %.o, $(filter %.S,$(notdir $(SRCS)))) \
		$(IGEN_GEN_SRCS:%.C=%.o)

#
# override standard install rule; provide a default DEST if not already set
#
ifndef DEST
DEST		= $(TO_CORE)/$(LIBRARY_DEST)
endif

ifndef USES_LIBDYNINSTRT_SO

INSTOBJS	= $(DEST)/$(TARGET)

ifdef BUILD_CODE_BLOCKS
INSTOBJS	+= $(DEST)/DYNINSTstartCode.o $(DEST)/DYNINSTendCode.o
endif
ifdef INCLUDE_CP_PROFILING
INSTOBJS	+= $(DEST)/RTpvmPiggy.o $(DEST)/$(TARGET2)
endif

#
# override standard link rule; libdyninst is not really a library or a program.
#
UNCOMMON_LINK = true
$(TARGET): $(OBJS)
	@$(RM) $(TARGET)
	@$(MAKE) $(VOUCHER)
	$(LD) $(LDFLAGS) -o $(TARGET) $(VOUCHER).o $(OBJS) $(LIBS) -lgcc

UNCOMMON_INSTALL = true

install: $(INSTOBJS) $(SYSEXTRAS)

$(DEST)/$(TARGET):       $(TARGET)
	-$(CP) $(TARGET) $(DEST)

$(DEST)/$(TARGET2):       $(TARGET2)
	-$(CP) $(TARGET2) $(DEST)

$(DEST)/RTpvmPiggy.o: RTpvmPiggy.o
	-$(CP) RTpvmPiggy.o $(DEST)

$(DEST)/DYNINSTstartCode.o: DYNINSTstartCode.o
	-$(CP) DYNINSTstartCode.o $(DEST)

$(DEST)/DYNINSTendCode.o: DYNINSTendCode.o
	-$(CP) DYNINSTendCode.o $(DEST)
endif

